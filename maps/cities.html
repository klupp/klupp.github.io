<!DOCTYPE html>
<html style="height: 100% !important;">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>

    <style type="text/css">
        #mapid { height: 100% !important; }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>


    <title>map</title>
<body style="height: 100% !important; margin: 0 !important;">

    <div id="mapid"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<!--    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>-->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script type="application/javascript" src="https://raw.githubusercontent.com/calvinmetcalf/leaflet-ajax/master/dist/leaflet.ajax.min.js"></script>

    <script src="https://d3js.org/d3.v3.js"></script>

</body>

<script type="application/javascript">

    var mymap = L.map('mapid').setView([41.6086, 21.7453], 8);



    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoiYWxrdXptYW4iLCJhIjoiY2s3ejF1NzQxMDFxaDNmbG5hZHZwMGJvcSJ9.kb13A3FHS8ruLv9FjOVfCQ'
    }).addTo(mymap);

    var general_legend = '<b>Карантин</b><hr style="width: auto; border-bottom:4px solid red">'

    var mk_cities_covid = $.ajax({
        url:"https://raw.githubusercontent.com/klupp/opendata/master/mk/covid19/maps/mk_municipalities_covid.geojson",
        dataType: "json",
        success: console.log("Covid data successfully loaded."),
        error: function (xhr) {
            alert(xhr.statusText)
        }
    });

    var quarantine = $.ajax({
        url:"https://raw.githubusercontent.com/klupp/opendata/master/mk/covid19/maps/covid-quarantine.geojson",
        dataType: "json",
        success: console.log("Covid data successfully loaded."),
        error: function (xhr) {
            alert(xhr.statusText)
        }
    });

    $.when(quarantine).done(function() {
        function style(feature) {
            return {
                weight:5,
                opacity: 1,
                color: 'red',
                fillOpacity: 0
            };
        }

        L.geoJSON(quarantine.responseJSON,
            {
                style: style
            }).addTo(mymap);
    });

    $.when(mk_cities_covid).done(function() {

        maxx = Math.max.apply(Math, mk_cities_covid.responseJSON.features.map(function(o) { return o.properties.count; }));
        minn = Math.min.apply(Math, mk_cities_covid.responseJSON.features.map(function(o) { return o.properties.count; }));
        min_log = Math.log10(minn + 1);
        max_log = Math.log10(maxx + 1);
        function getColor(d) {
            var color = d3.scale.linear()
                .domain([minn, maxx])
                .range(["orange", "darkred"]);

            return color(d);
        }

        function getOpacity(d) {
            val = Math.log10(d + 1);

            res = ((val - min_log) / (max_log - min_log))
            res_final = res > 0 ? res * 0.8 + 0.1 : 0.01;
            return res_final;
        }

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.count),
                weight: 0.3,
                opacity: 1,
                color: 'black',
                dashArray: '3',
                fillOpacity: getOpacity(feature.properties.count)
            };
        }

        var geojson;

        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed

        info.update = function (props) {
            console.log(props)
            this._div.innerHTML = (props ?
                `
                    <h4>${props.id}:</h4>
                    <table style="font-size: 12pt;">
                        <tr style="color: darkgoldenrod; font-weight: bold">
                            <td>${props.count}</td>
                            <td>Активни</td>
                        </tr>
                        <tr style="color: darkred; font-weight: bold">
                            <td>${props.count_infected}</td>
                            <td>Заразени</td>
                        </tr>
                        <tr style="color: darkgreen; font-weight: bold">
                            <td>${props.count_healed}</td>
                            <td>Излечени</td>
                        </tr>
                        <tr style="color: black; font-weight: bold">
                            <td>${props.count_healed}</span></td>
                            <td>Мртви</td>
                        </tr>
                        <tr>
                            <td>${props.population}</span></td>
                            <td>Популација</td>
                        </tr>
                    </table>
                `
                : 'Кликни на општина');
        };

        function highlightFeature(e) {
            geojson.resetStyle();
            var layer = e.target;

            layer.setStyle({
                weight: 2,
                color: 'green',
                dashArray: '',
                fillOpacity: 0.6,
                fillColor: 'grey'
            });

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            info.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            geojson.resetStyle();
            info.update();
        }

        function zoomToFeature(e) {
            mymap.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                // mouseover: highlightFeature,
                // mouseout: resetHighlight,
                click: highlightFeature,
                touch: highlightFeature
            });
        }

        geojson = L.geoJSON(mk_cities_covid.responseJSON,
            {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(mymap);

        info.addTo(mymap);

        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {

            num_cols = 5;
            var div = L.DomUtil.create('div', 'info legend'),
                grades = Array.from({length: num_cols}, (x,i) => Math.floor((i/(num_cols - 1)) * (maxx - (minn + 1)) + (minn + 1))),
                labels = [];

            div.innerHTML += general_legend;
            var table = '<b>Број активни случаи</b><br><table cellspacing="0">';
            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < num_cols; i++) {
                table += `
                    <tr>
                        <td style="padding: 0 !important;"><i style="background: ${getColor(grades[i])}; opacity: ${getOpacity(grades[i])}"></i></td>
                        <td style="padding: 0 !important;">${grades[i]}${(grades[i + 1] ? '&ndash;' + grades[i + 1] : '+')}</td>
                    </tr>

                `
            }
            table += '</table>';

            div.innerHTML += table;

            return div;
        };

        legend.addTo(mymap);
    });
</script>
</html>
